<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="王福强的博客， 一个架构士的思考与沉淀">
    <meta name="keywords" content="architecture, book author, thinker, fighter, 架构, 思考, 技术, 武术, 哲学">
    <meta name="author" content="王福强">
        <link rel="icon" href="/favicon.ico">
    <title> - 一个架构士的思考与沉淀</title>
    <!-- 百度统计 -->
    <script>
      var _hmt = _hmt || [];
      (function() {
          var hm = document.createElement("script");
          hm.src = "//hm.baidu.com/hm.js?4b0cf57d9b677da796218f27d72dbbca";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
      })();
    </script>

	<link href="/css/custom.css" rel="stylesheet"/>
	<link rel="shortcut icon" href="/favicon.ico"/>

<style type="text/css">code{white-space: pre;}</style>
        
	<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
	<!--[if lt IE 9]>
	  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.2/html5shiv.js"></script>
	  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->

</head>

<body>

    <div class="masthead">
		<!--
    <h1 class="masthead-title fq">
      <a href="/">扶墙老师</a>
    
    </h1>
    -->
    <a href="/"><img src="/images/afoo.PNG"/></a>
		<p class="masthead-lead">瞎子摸象的践行者</p>
	
		<hr class="masthead-hr">

	  	<ul class="masthead-nav">
            <li class="nav-item"><a class="nav-link" href="/favorite.html">我的收藏</a></li>
            <li class="nav-item"><a class="nav-link" href="/dashboard.html">金融看板</a></li>
            <li class="nav-item"><a class="nav-link" href="/columns.html">专栏文章</a></li>
            <li class="nav-item"><a class="nav-link" href="/references.html">快捷参考</a></li>
            <li class="nav-item"><a class="nav-link" href="/whoami.html">我是何人</a></li>
            <li class="nav-item"><a class="nav-link" href="/interlinks.html">友情链接</a></li>
            <li class="nav-item"><a class="nav-link" href="/feeds.xml">RSS订阅</a></li>
		</ul>

  		<hr class="masthead-hr">

	  	<ul class="masthead-nav">
            <li class="nav-item"><small>©afoo.me</small></li>
            <li class="nav-item"><small>Powered by <a href="http://pandoc.org/">pandoc</a> and <a href="http://rometools.github.io/rome/">ROME</a></small></li>
		</ul>
  		
	</div>


    <div class="listing">

<div class="row">

<hr>

<div id="TOC">
<ul>
<li><a href="#故障分析与处理的一些经验"><span class="toc-section-number">1</span> 故障分析与处理的一些经验</a><ul>
<li><a href="#一般性故障的定位"><span class="toc-section-number">1.1</span> 一般性故障的定位</a><ul>
<li><a href="#故障定位"><span class="toc-section-number">1.1.1</span> 故障定位</a></li>
<li><a href="#性能定位"><span class="toc-section-number">1.1.2</span> 性能定位</a></li>
<li><a href="#线上bug"><span class="toc-section-number">1.1.3</span> 线上BUG</a></li>
</ul></li>
<li><a href="#针对线上故障的解决之道"><span class="toc-section-number">1.2</span> 针对线上故障的解决之道</a><ul>
<li><a href="#监控与预警"><span class="toc-section-number">1.2.1</span> 监控与预警：</a></li>
<li><a href="#降级与响应"><span class="toc-section-number">1.2.2</span> 降级与响应：</a></li>
<li><a href="#回滚与切流量"><span class="toc-section-number">1.2.3</span> 回滚与切流量：</a></li>
</ul></li>
<li><a href="#一般故障排查流程"><span class="toc-section-number">1.3</span> 一般故障排查流程：</a></li>
<li><a href="#线上系统解决方案"><span class="toc-section-number">1.4</span> 线上系统解决方案</a></li>
</ul></li>
</ul>
</div>
<hr/>

<h1 id="故障分析与处理的一些经验"><span class="header-section-number">1</span> 故障分析与处理的一些经验</h1>
<h2 id="一般性故障的定位"><span class="header-section-number">1.1</span> 一般性故障的定位</h2>
<h3 id="故障定位"><span class="header-section-number">1.1.1</span> 故障定位</h3>
<ul>
<li>网络：针对各个重要的服务器节点实时icmp监控，高延时或者不通做预警</li>
<li>数据库连接池：连接池连接数是否正常（与连接数的配置也有关系，是否配置合理）</li>
<li>cdn连接：网络连通性，缓存是否失效</li>
<li>nginx：日志分析，是否有刷连接，400+，500+问题的比例</li>
<li>缓存异常：缓存连接</li>
<li>消息：消费者出现异常，调用失效，导致积压；生产者线程数为0或者低于正常配置</li>
<li>应用日志：日志生产量超过正常范围或者低于一个范围阈值，做简单的预警</li>
<li>服务接口</li>
</ul>
<h3 id="性能定位"><span class="header-section-number">1.1.2</span> 性能定位</h3>
<ul>
<li>tp99/tp90：性能未达标，根据监控定位代码，直接优化代码（减少数据库查询次数，减少查询缓存的次数等）</li>
<li>CPU和内存：是否有死锁和大量爆内存操作，缓存超常</li>
<li>负载：复杂运算（比如频繁读写大文件，高频率查询数据库），定时数据库任务</li>
<li>jvm：死锁和GC的情况</li>
<li>缓存：命中率低</li>
<li>硬盘空间：日志写满，需要有阈值报警</li>
</ul>
<h3 id="线上bug"><span class="header-section-number">1.1.3</span> 线上BUG</h3>
<ul>
<li>一致性问题：分布式事务与最终一致性</li>
<li>访问量/订单波动率：访问量/订单的波动率高于阈值，波动异常</li>
<li>服务接口：降级方案备份</li>
</ul>
<h2 id="针对线上故障的解决之道"><span class="header-section-number">1.2</span> 针对线上故障的解决之道</h2>
<h3 id="监控与预警"><span class="header-section-number">1.2.1</span> 监控与预警：</h3>
<ul>
<li>针对网络，对所有的节点都要有基本的ICMP监控；</li>
<li>针对数据库，都需要有基本的连通性测试，以及连接池，qps/tps，各种命中率的监控（比如缓存的命中很低，大部分做全表扫描）</li>
<li>针对nginx，需要对日志做状态分析，可以分钟级的对日志做监控，分析出每分钟各种状态的请求，从而分析出对于url是否异常，能快速感知线上的问题</li>
<li>针对缓存，需要连通性，连接数，命中率等监控</li>
<li>针对消息，是否有积压和死线程，从而定位生产者和消费者是否异常</li>
<li>针对日志，日志的生产量波动率以及对特殊字眼的监控分析</li>
<li>针对服务，dubbo整套服务治理方案</li>
</ul>
<h3 id="降级与响应"><span class="header-section-number">1.2.2</span> 降级与响应：</h3>
<ul>
<li>手动降级：网络切换，数据库切换（一般作为自动降级方案）</li>
<li>自动降级：对数据做分级分析，分成可降级和不可降级数据，在应用中做控制。 缓存和数据库主从自动切换 可降级数据无法获取自动丢弃 备份方案自动切换 服务接口本地方案</li>
</ul>
<h3 id="回滚与切流量"><span class="header-section-number">1.2.3</span> 回滚与切流量：</h3>
<ul>
<li>支持回滚：回滚应用，暂时保持线上正常</li>
<li>部分流量切回：切分流量上线，保证整个应用不受影响</li>
</ul>
<h2 id="一般故障排查流程"><span class="header-section-number">1.3</span> 一般故障排查流程：</h2>
<ul>
<li>线上应用已经打不开（非404错误）：网络入口=》nginx服务器</li>
<li>线上应用已经打不开（404错误）：应用服务器</li>
<li>线上应用能打开，但时好时坏 ：个别应用服务器挂掉</li>
<li>线上服务正常，但提交订单失败 ：这种情况很复杂，有以下情况： 从网络开始排查：网络入口=》订单的服务器=》订单服务接口/订单数据库 通过日志服务器查看是否有异常：日志服务=》异常定位 tp99/90数据中的exception是否有大波动：性能监控数据=》定位异常</li>
<li>线上服务能打开，但是执行缓慢 ：这种最难分析，包括CPU和内存都有可能影响</li>
</ul>
<h2 id="线上系统解决方案"><span class="header-section-number">1.4</span> 线上系统解决方案</h2>
<ul>
<li>小组内指派监控和管理应用，比如有人专门负责日志的排查，有人负责网络的排查，达到快速解决问题</li>
<li>通过短信和邮件报警形式把已经出现的问题快速通知给相关人员</li>
<li>做好充分的降级和备案措施，能快速解决线上问题（5分钟~10分钟能做到发现到解决问题）或者说能最大程度的做到自动降级</li>
</ul>
<hr>
<div>
<img src="/images/qrcode_for_gh_4fe672b2e860_430.jpg"/>
</div>
<hr>

  <!-- 多说评论框 start -->
  <div class="ds-thread" data-thread-key="故障分析与处理的一些经验.html" data-title="">
  </div>
  <!-- 多说评论框 end -->
  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
  <script type="text/javascript">
  var duoshuoQuery = {short_name:"afoo"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0] 
       || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
    </script>
  <!-- 多说公共JS代码 end -->


</div>



</body></html>